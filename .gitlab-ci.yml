image:
  name: hashicorp/terraform:light
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

variables:
  TF_ROOT: ${CI_PROJECT_DIR}
  TF_STATE_NAME: ${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}
  SOPS_VERSION: "3.7.3"

cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${TF_ROOT}/.terraform

before_script:
    - cd ${TF_ROOT}
    - terraform --version
    - terraform init
    - curl -fsSL https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux -o sops
    - chmod +x sops
    - mv sops /usr/local/bin/
    - echo "${SOPS_GPG_KEY}" | gpg --import
    - cd ${TF_ROOT}
    - sops -d terraform.tfvars.enc > terraform.tfvars
    - terraform init

stages:
  - validate
  - plan
  - apply

validate:
    stage: validate
    script:
        - terraform validate

plan:
    stage: plan
    script:
        - terraform plan -out=tfplan -var-file=terraform.tfvars
    artifacts:
        paths:
          - -tfplan

apply:
    stage: apply
    script:
        - terraform apply -var-file=terraform.tfvars -auto-approve tfplan 
    when: manual
    only: 
        - main